<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
label{
  display:block;
  margin-top:12px;
  font-weight:600;
}
input,select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  margin-top:14px;
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button.edit{ background:#16a34a; }
button.delete{ background:#dc2626; }
button.logout{ background:#111827; float:right; }
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
}
th{
  background:#e5e7eb;
}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>
<button class="logout" onclick="logout()">Logout</button>

<!-- ADD / EDIT WORK -->
<div class="card">
  <h3 id="formTitle">Add Work</h3>

  <label for="farmerSelect">Select Farmer</label>
  <select id="farmerSelect" title="Select Farmer"></select>

  <label for="workType">Work Type</label>
  <input id="workType" title="Work Type" placeholder="Enter work type">

  <label for="minutes">Minutes</label>
  <input id="minutes" type="number" title="Minutes" placeholder="Enter minutes">

  <label for="rate">Rate per 60 minutes</label>
  <input id="rate" type="number" title="Rate per 60 minutes" placeholder="Enter rate">

  <button id="submitBtn">Add Work</button>
</div>

<!-- WORK HISTORY -->
<div class="card">
  <h3>Work History</h3>

  <label for="farmerFilter">Filter by Farmer</label>
  <select id="farmerFilter" title="Filter by Farmer"></select>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Farmer</th>
        <th>Work</th>
        <th>Minutes</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</div>

<script>
const API = "https://tractor-back-1l40.onrender.com";
const token = () => localStorage.getItem("adminToken");

let editWorkId = null;

if(!token()){
  location.href = "index.html";
}

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  const res = await fetch(API + "/api/admin/farmers", {
    headers:{ Authorization:"Bearer " + token() }
  });

  const farmers = await res.json();

  farmerSelect.innerHTML = '<option value="">Select Farmer</option>';
  farmerFilter.innerHTML = '<option value="">Select Farmer</option>';

  farmers.forEach(f=>{
    farmerSelect.innerHTML += `<option value="${f._id}">${f.name} (${f.phone})</option>`;
    farmerFilter.innerHTML += `<option value="${f._id}">${f.name} (${f.phone})</option>`;
  });
}

/* ================= LOAD WORKS ================= */
async function loadWorks(){
  tbody.innerHTML = "";
  if(!farmerFilter.value) return;

  const res = await fetch(
    API + "/api/work?farmerId=" + farmerFilter.value,
    { headers:{ Authorization:"Bearer " + token() } }
  );

  const data = await res.json();

  data.works.forEach(w=>{
    tbody.innerHTML += `
      <tr>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.farmer.name}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>${w.totalAmount}</td>
        <td>
          <button class="edit"
            onclick="startEdit('${w._id}','${w.farmer._id}','${w.workType}',${w.minutes},${w.ratePer60})">
            Edit
          </button>
          <button class="delete" onclick="deleteWork('${w._id}')">
            Delete
          </button>
        </td>
      </tr>
    `;
  });
}

/* ================= ADD / UPDATE ================= */
submitBtn.onclick = async ()=>{
  const body = {
    farmerId: farmerSelect.value,
    workType: workType.value,
    minutes: Number(minutes.value),
    ratePer60: Number(rate.value)
  };

  if(!body.farmerId || !body.workType || !body.minutes || !body.ratePer60){
    alert("All fields are required");
    return;
  }

  if(editWorkId){
    await fetch(API + "/api/work/" + editWorkId, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer " + token()
      },
      body: JSON.stringify(body)
    });
    alert("Work Updated");
  } else {
    await fetch(API + "/api/work/add", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer " + token()
      },
      body: JSON.stringify(body)
    });
    alert("Work Added");
  }

  resetForm();
  loadWorks();
};

/* ================= EDIT ================= */
function startEdit(id, farmerId, wt, mins, rate){
  editWorkId = id;

  farmerSelect.value = farmerId;
  workType.value = wt;
  minutes.value = mins;
  rate.value = rate;

  formTitle.innerText = "Edit Work";
  submitBtn.innerText = "Update Work";

  window.scrollTo({ top:0, behavior:"smooth" });
}

/* ================= DELETE ================= */
async function deleteWork(id){
  if(!confirm("Delete this work?")) return;

  await fetch(API + "/api/work/" + id, {
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });

  loadWorks();
}

/* ================= RESET ================= */
function resetForm(){
  editWorkId = null;
  farmerSelect.value = "";
  workType.value = "";
  minutes.value = "";
  rate.value = "";
  formTitle.innerText = "Add Work";
  submitBtn.innerText = "Add Work";
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.clear();
  location.href = "index.html";
}

farmerFilter.onchange = loadWorks;
loadFarmers();
</script>

</body>
</html>
