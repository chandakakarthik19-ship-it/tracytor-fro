<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
}
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:var(--bg);
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}
label{display:block;margin-top:12px;font-weight:600}
input,select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border:1px solid var(--border);
  border-radius:8px;
}
button{
  margin-top:14px;
  padding:10px 16px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  background:var(--primary);
  color:white;
}
button.success{background:var(--success)}
button.danger{background:var(--danger)}
button.warning{background:var(--warning);color:#000}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}
.summary{
  display:flex;
  gap:15px;
  margin-top:15px;
}
.summary div{
  flex:1;
  background:#f1f5f9;
  padding:12px;
  border-radius:10px;
}
.summary input{
  border:none;
  background:none;
  font-size:20px;
  font-weight:700;
}
.center{text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>

<!-- ADD WORK -->
<div class="card">
  <h3>Add Work</h3>

  <label>Farmer</label>
  <select id="farmerSelect"></select>

  <label>Work Type</label>
  <input id="workType">

  <label>Minutes</label>
  <input id="minutes">

  <label>Rate / Hour</label>
  <input id="rate">

  <button id="submitBtn">Add Work</button>
</div>

<!-- PAYMENT -->
<div class="card">
  <h3>Farmer Payment</h3>

  <label>Select Farmer</label>
  <select id="paymentFarmer"></select>

  <label>Amount</label>
  <input id="paymentAmount" type="number">

  <button class="success" onclick="makePayment()">Add Payment</button>
</div>

<!-- HISTORY -->
<div class="card">
  <label>Farmer History</label>
  <select id="farmerFilter"></select>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Work</th>
        <th>Minutes</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="summary">
    <div><label>Total</label><input id="totalBox" readonly></div>
    <div><label>Paid</label><input id="paidBox" readonly></div>
    <div><label>Balance</label><input id="balanceBox" readonly></div>
  </div>
</div>

</div>

<script>
const API = "http://localhost:4000";
const token = () => localStorage.getItem("token");

window.onload = loadFarmers;

/* LOAD FARMERS */
async function loadFarmers(){
  const res = await fetch(API+"/api/admin/farmers",{headers:{Authorization:"Bearer "+token()}});
  const data = await res.json();
  let opt = '<option value="">Select</option>';
  data.farmers.forEach(f=>opt+=`<option value="${f._id}">${f.name}</option>`);
  farmerSelect.innerHTML = farmerFilter.innerHTML = paymentFarmer.innerHTML = opt;
}

/* ADD PAYMENT */
async function makePayment(){
  const farmerId = paymentFarmer.value;
  const amount = Number(paymentAmount.value);

  await fetch(API+"/api/admin/payment",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({ farmerId, amount })
  });

  paymentAmount.value="";
  farmerFilter.value = farmerId;
  loadHistory();
}

/* LOAD HISTORY */
farmerFilter.onchange = loadHistory;

async function loadHistory(){
  tbody.innerHTML="";
  const res = await fetch(API+"/api/admin/history/"+farmerFilter.value,{
    headers:{Authorization:"Bearer "+token()}
  });
  const { works, payments } = await res.json();

  let total=0, paid=0;

  works.forEach(w=>{
    total += w.totalAmount;
    tbody.innerHTML += `
    <tr>
      <td>${new Date(w.date).toLocaleDateString()}</td>
      <td>${w.workType}</td>
      <td>${w.minutes}</td>
      <td>${w.ratePer60}</td>
      <td>${w.totalAmount}</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>`;
  });

  payments.forEach(p=>{
    paid += p.amount;
    tbody.innerHTML += `
    <tr style="background:#ecfdf5">
      <td>${new Date(p.date).toLocaleDateString()}</td>
      <td>-</td><td>-</td><td>-</td><td>-</td>
      <td>${p.amount}</td>
      <td>-</td>
      <td>
        <button class="warning" onclick="editPayment('${p._id}',${p.amount})">Edit</button>
        <button class="danger" onclick="deletePayment('${p._id}')">Delete</button>
      </td>
    </tr>`;
  });

  totalBox.value = total;
  paidBox.value = paid;
  balanceBox.value = total - paid;
}

/* EDIT PAYMENT */
async function editPayment(id, oldAmt){
  const amt = prompt("New amount", oldAmt);
  if(!amt) return;
  await fetch(API+"/api/admin/payment/"+id,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({ amount:Number(amt) })
  });
  loadHistory();
}

/* DELETE PAYMENT */
async function deletePayment(id){
  if(!confirm("Delete payment?")) return;
  await fetch(API+"/api/admin/payment/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token()}
  });
  loadHistory();
}
</script>

</body>
</html>
