<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>

  <style>
  :root{
    --primary:#2563eb;
    --success:#16a34a;
    --danger:#dc2626;
    --bg:#f3f4f6;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#1f2937;
    --muted:#6b7280;
  }

  *{
    box-sizing:border-box;
  }

  body{
    margin:0;
    font-family:"Segoe UI", Tahoma, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .container{
    max-width:800px;
    margin:auto;
    padding:24px;
  }

  h2{
    color:var(--primary);
    margin-bottom:16px;
  }

  h3{
    margin-top:0;
    margin-bottom:10px;
    color:#111827;
  }

  .card{
    background:var(--card);
    border-radius:12px;
    padding:22px;
    margin-bottom:22px;
    box-shadow:0 10px 25px rgba(0,0,0,0.06);
  }

  label{
    display:block;
    margin-top:14px;
    font-weight:600;
    font-size:14px;
    color:#374151;
  }

  input, select{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    border:1px solid var(--border);
    border-radius:8px;
    font-size:14px;
    background:#f6faf986;
  }

  input:focus, select:focus{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(37,99,235,0.15);
  }

  button{
    padding:10px 16px;
    margin-top:14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    background:var(--primary);
    color:rgb(236, 231, 231);
    transition:0.2s;
  }

  button:hover{
    opacity:0.9;
  }

  /* TABLE */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:16px;
    background:rgb(10, 236, 236);
    border-radius:10px;
    overflow:hidden;
  }

  th{
    background:#bada04;
    font-weight:600;
    font-size:13px;
    color:#374151;
    padding:12px;
    border-bottom:1px solid var(--border);
  }

  td{
    padding:12px;
    border-bottom:1px solid var(--border);
    font-size:14px;
    color:#111827;
  }

  tr:hover{
    background:#f9fafb;
  }

  /* ACTION BUTTONS IN TABLE */
  td button{
    margin:2px;
    padding:6px 10px;
    font-size:12px;
    border-radius:6px;
  }

  td button:nth-child(1){
    background:var(--success);
  }

  td button:nth-child(2){
    background:#facc15;
    color:#111827;
  }

  td button:nth-child(3){
    background:var(--danger);
  }

  /* SUMMARY BOXES */
  .summary{
    display:flex;
    gap:20px;
    margin-top:20px;
  }

  .summary > div{
    flex:1;
    background:#06e7a4;
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
  }

  .summary label{
    margin:0;
    font-size:13px;
    color:var(--muted);
  }

  .summary input{
    margin-top:6px;
    padding:0;
    border:none;
    background:none;
    font-size:20px;
    font-weight:700;
    color:#111827;
  }

  @media(max-width:768px){
    .summary{
      flex-direction:column;
    }
  }
  /* LOGOUT SECTION */
.logout-container{
  text-align: center;
  margin-top: 40px;
}

.logout-btn{
  background: #dc2626;
  color: white;
  width: 220px;
}

</style>
</head>

<body>
<div class="container">

  <h2>Admin Dashboard</h2>

  <!-- ADD / EDIT WORK -->
  <div class="card">
    <h3 id="formTitle">Add Work</h3>

    <label for="farmerSelect">Farmer</label>
    <select id="farmerSelect"
            aria-label="Select Farmer"
            title="Select Farmer">
      <option value="">Loading farmers...</option>
    </select>

    <label for="workType">Work Type</label>
    <select id="workType"
            aria-label="Work Type"
            title="Work Type">
      <option value="">-- Select --</option>
      <option>దుక్కు</option>
      <option>లోడింగ్</option>
      <option>రోటావేటర్</option>
      <option>జొన్నలు</option>
      <option>వరిసేను ఆట</option>
      <option>గత్తం</option>
    </select>

    <label for="minutes">Time Worked (1.2 = 1h 20m)</label>
    <input id="minutes"
           type="text"
           placeholder="Enter time"
           aria-label="Time Worked"
           title="Time Worked">

    <label for="rate">Rate per Hour</label>
    <input id="rate"
           type="number"
           placeholder="Enter rate"
           aria-label="Rate per Hour"
           title="Rate per Hour">

    <button id="submitBtn">Add Work</button>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <label for="farmerFilter">Farmer History</label>
    <select id="farmerFilter"
            aria-label="Farmer History"
            title="Farmer History">
      <option value="">Select farmer</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Work</th>
          <th>Minutes</th>
          <th>Rate</th>
          <th>Total</th>
          <th>Paid</th>
          <th>Balance</th>
          <th>Payment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="summary">
      <div>
        <label for="totalBox">Total</label>
        <input id="totalBox" readonly aria-label="Total">
      </div>
      <div>
        <label for="paidBox">Paid</label>
        <input id="paidBox" readonly aria-label="Paid">
      </div>
      <div>
        <label for="balanceBox">Balance</label>
        <input id="balanceBox" readonly aria-label="Balance">
      </div>
    </div>
  </div>
<!-- LOGOUT BUTTON -->
<div class="logout-container">
  <button
    id="logoutBtn"
    class="logout-btn"
    aria-label="Logout Admin"
  >
    Logout
  </button>
</div>

</div>

<script>
const API = "https://tractor-back-1l40.onrender.com";
const token = () => localStorage.getItem('token');

let editWorkId = null;

window.onload = loadFarmers;

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  const res = await fetch(API + '/api/admin/farmers', {
    headers:{ Authorization:'Bearer ' + token() }
  });
  const data = await res.json();
  const farmers = data.farmers || [];

  const options = farmers.map(f =>
    `<option value="${f._id}">${f.name}</option>`
  ).join('');

  farmerSelect.innerHTML =
    '<option value="">-- Select Farmer --</option>' + options;

  farmerFilter.innerHTML =
    '<option value="">-- Select Farmer --</option>' + options;
}

/* ================= ADD / UPDATE WORK ================= */
submitBtn.onclick = async ()=> {
  let mins = 0;
  const t = minutes.value.trim();
  if(t.includes('.')){
    const [h,m] = t.split('.');
    mins = Number(h)*60 + Number(m.padEnd(2,'0'));
  } else {
    mins = Number(t);
  }

  const body = {
    farmerId: farmerSelect.value,
    workType: workType.value,
    minutes: mins,
    ratePer60: Number(rate.value)
  };

  if(editWorkId){
    await fetch(API + '/api/admin/work/' + editWorkId,{
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        Authorization:'Bearer ' + token()
      },
      body: JSON.stringify(body)
    });
    alert('Work Updated');
  } else {
    await fetch(API + '/api/admin/work',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        Authorization:'Bearer ' + token()
      },
      body: JSON.stringify(body)
    });
    alert('Work Added');
  }

  resetForm();
  loadHistory();
};

/* ================= LOAD HISTORY ================= */
farmerFilter.onchange = loadHistory;

async function loadHistory(){
  tbody.innerHTML = '';
  totalBox.value = paidBox.value = balanceBox.value = '';

  if(!farmerFilter.value) return;

  const res = await fetch(
    API + '/api/admin/work?farmerId=' + farmerFilter.value,
    { headers:{ Authorization:'Bearer ' + token() } }
  );
  const data = await res.json();
  const works = data.works || [];

  let total = 0, paid = 0;

  works.forEach(w=>{
    const p = w.paymentGiven || 0;
    const b = (w.totalAmount || 0) - p;

    total += w.totalAmount || 0;
    paid += p;

    tbody.innerHTML += `
      <tr>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>${w.totalAmount}</td>
        <td>${p}</td>
        <td>${b}</td>
        <td>
          <input id="pay_${w._id}" type="number">
          <button onclick="pay('${w._id}')">Pay</button>
        </td>
        <td>
          <button onclick="startEdit('${w._id}','${w.farmer._id}','${w.workType}',${w.minutes},${w.ratePer60})">Edit</button>
          <button onclick="deleteWork('${w._id}')">Delete</button>
        </td>
      </tr>`;
  });

  totalBox.value = total;
  paidBox.value = paid;
  balanceBox.value = total - paid;
}

/* ================= PAYMENT ================= */
async function pay(id){
  const amt = Number(document.getElementById('pay_'+id).value);
  if(!amt) return alert('Enter amount');

  await fetch(API + '/api/admin/payment/' + farmerFilter.value,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:'Bearer ' + token()
    },
    body: JSON.stringify({ workId:id, amount:amt })
  });

  loadHistory();
}

/* ================= DELETE ================= */
async function deleteWork(id){
  if(!confirm('Delete work?')) return;

  await fetch(API + '/api/admin/work/' + id,{
    method:'DELETE',
    headers:{ Authorization:'Bearer ' + token() }
  });

  loadHistory();
}

/* ================= LOGOUT ================= */
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.clear();
  location.href = 'index.html';
});
</script>

</body>
</html>
